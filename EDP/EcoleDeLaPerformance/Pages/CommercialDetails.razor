@page "/details/{userId}/{weekId}"
@using EcoleDeLaPerformance.Ui.Interfaces
@using EcoleDeLaPerformance.Ui.Models
@using EcoleDeLaPerformance.Ui.Models.BI
@using EcoleDeLaPerformance.Ui.Services
@using EcoleDeLaPerformance.Ui.Shared.Components;
@inject StateContainerService stateContainerService
@inject IUserService userService
@inject IContractService contractService
@inject IBriefService briefService
@inject IDebriefService debriefService

<div class="px-6">
    <MudPaper Elevation="1" Class="p-4 mb-6">
        <MudGrid>
            <MudItem xs="12" md="6" Class="d-flex">
                <MudAvatar Size="Size.Large">
                    @if (userInfo.ProfilePicturePath != null)
                    {
                        <MudImage Src="@userInfo.ProfilePicturePath"></MudImage>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.PhotoCamera" />
                    }
                </MudAvatar>
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="fw-bold textcontent mt-3 mx-4">@commercial.Name</MudText>
            </MudItem>

            <MudFlexBreak />

            <MudItem xs="12" md="6">
                <MudTable Items="allContracts" Elevation="1" Bordered="false" HeaderClass="bg-primary bg-opacity-10">
                    <HeaderContent>
                        <MudTh Class="fw-bold fs-6">A faire</MudTh>
                        <MudTh Class="fw-bold fs-6">Objectif annuel</MudTh>
                        <MudTh Class="fw-bold fs-6">Compte rendu annuel</MudTh>
                        <MudTh Class="fw-bold fs-6">Indicateur</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudText Typo="Typo.subtitle2">@context.label</MudText>
                        </MudTd>
                        <MudTd>
                            <MudText Typo="Typo.subtitle2">@context.contracts.Count()</MudText>
                        </MudTd>
                        <MudTd>
                            <MudText Typo="Typo.subtitle2">@context.contracts.Count()</MudText>
                        </MudTd>
                        <MudTd>
                            <MudText Typo="Typo.subtitle2">@GetIndicatorIcon(context.contracts.Count(), context.contracts.Count())</MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudPaper Class="p-4 rounded-lg" Style="background: linear-gradient(to right, #fef2f2, #fee2e2);" MaxHeight="108px">
                            <MudText Typo="Typo.subtitle1" Class="text-red-600 font-medium">CA généré</MudText>
                            <MudText Typo="Typo.h6" Class="text-red-700 font-bold">@turnover.ToString("F") €</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudPaper Class="p-4 rounded-lg" Style="background: linear-gradient(to right, #ecfdf5, #d1fae5);" MaxHeight="108px">
                            <MudText Typo="Typo.subtitle1" Class="text-green-600 font-medium">Variable</MudText>
                            <MudText Typo="Typo.h6" Class="text-green-700 font-bold">@bonus.ToString("F") €</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudItem>
            <MudItem xs="12">
                <MudPaper Elevation="2" Class="p-4 mb-6">
                    <MudPaper Elevation="2" Class="p-4 mb-6">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">Semaine du @selectedPlanning.CreatedAt.AddDays(-((int)selectedPlanning.CreatedAt.DayOfWeek == 0 ? 6 : (int)selectedPlanning.CreatedAt.DayOfWeek - 1)).ToShortDateString()</MudText>
                        </MudStack>
                        <div>
                            <div class="drop-row my-2">
                                @foreach (var day in days)
                                {
                                    <div style="text-align:center; font-weight:bold;">
                                        @day
                                    </div>
                                }
                            </div>
                            @for (int row = 0; row < 2; row++)
                            {
                                <div class="drop-row">
                                    @for (int col = 0; col < 5; col++)
                                    {
                                        var planningKey = $"planning{row}{col}";
                                        var task = selectedPlanning.PlanningsTasks
                                        .FirstOrDefault(t => t.Identifier == planningKey);

                                        <MudPaper Class="ma-4 w-100 d-flex align-items-center justify-center" Style="height:70px; background: linear-gradient(to right, #fef2f2, #fee2e2);">
                                            @if (task is not null)
                                            {
                                                <MudText Typo="Typo.subtitle1" Class="ma-2">@task.Task.Title</MudText>
                                            }
                                        </MudPaper>
                                    }
                                </div>
                            }
                        </div>
                    </MudPaper>
                    <MudTabs @bind-ActivePanelIndex="_activeTab" Rounded="true" Centered="true" MinimumTabWidth="400px">
                        <MudTabPanel Text="Briefing">
                            <MudGrid Class="mt-4">
                                <MudItem xs="12" lg="6">
                                    <MudPaper Elevation="1" Class="p-4">
                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
                                            <MudIcon Icon="@Icons.Material.Filled.TrackChanges" Color="Color.Warning" />
                                            <MudText Typo="Typo.h6">Engagement de signature de la semaine</MudText>
                                        </MudStack>
                                        <MudList Dense="true" T="string" Disabled>
                                            @foreach (var brief in briefs)
                                            {
                                                @foreach (string signatureCommitment in (brief?.SignatureCommitment ?? "").Split('\n', StringSplitOptions.RemoveEmptyEntries))
                                                {
                                                    <EngagementItem Text="@signatureCommitment" />
                                                }
                                            }
                                        </MudList>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" lg="6">
                                    <MudPaper Elevation="1" Class="p-4">
                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
                                            <MudIcon Icon="@Icons.Material.Filled.AssignmentTurnedIn" Color="Color.Secondary" />
                                            <MudText Typo="Typo.h6">Dossiers à checker</MudText>
                                        </MudStack>
                                        <MudList Dense="true" T="string" Disabled>
                                            @foreach (var brief in briefs)
                                            {
                                                @foreach (string filesToCheck in (brief?.FilesToCheck ?? "").Split('\n', StringSplitOptions.RemoveEmptyEntries))
                                                {
                                                    <FileItem Text="@filesToCheck" />
                                                }
                                            }
                                        </MudList>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                        <MudTabPanel Text="Debriefing">
                            <MudGrid Class="mt-4">
                                <MudItem xs="12" lg="6">
                                    <MudPaper Elevation="1" Class="p-4">
                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
                                            <MudIcon Icon="@Icons.Material.Filled.BarChart" Color="Color.Warning" />
                                            <MudText Typo="Typo.h6">Affaires en cours</MudText>
                                        </MudStack>
                                        <MudList Dense="true" T="string" Disabled>
                                            @foreach (var debrief in debriefs)
                                            {
                                                @foreach (string businessInProgress in (debrief?.BusinessInProgress ?? "").Split('\n', StringSplitOptions.RemoveEmptyEntries))
                                                {
                                                    <EngagementItem Text="@businessInProgress" />
                                                }
                                            }
                                        </MudList>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" lg="6">
                                    <MudPaper Elevation="1" Class="p-4">
                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
                                            <MudIcon Icon="@Icons.Material.Filled.BarChart" Color="Color.Secondary" />
                                            <MudText Typo="Typo.h6">Affaires levées</MudText>
                                        </MudStack>
                                        <MudList Dense="true" T="string" Disabled>
                                            @foreach (var debrief in debriefs)
                                            {
                                                @foreach (string completedBusiness in (debrief?.CompletedBusiness ?? "").Split('\n', StringSplitOptions.RemoveEmptyEntries))
                                                {
                                                    <FileItem Text="@completedBusiness" />
                                                }
                                            }
                                        </MudList>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="12" md="12">
                                    <MudPaper Elevation="1">
                                        <MudCardContent>
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                                                <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary" />
                                                <MudText Typo="Typo.h6">Dossiers et contrats signés</MudText>
                                            </MudStack>
                                            <MudGrid>
                                                <MudItem xs="12" md="4">
                                                    <DonutCard Title="Location" Icon="@Icons.Material.Filled.Leaderboard" IconColor="Color.Secondary" Data="@rentalData" Number="5" />
                                                </MudItem>
                                                <MudItem xs="12" md="4">
                                                    <DonutCard Title="Achats" Icon="@Icons.Material.Filled.Leaderboard" IconColor="Color.Secondary" Data="@purchaseData" Number="2" />
                                                </MudItem>
                                                <MudItem xs="12" md="4">
                                                    <DonutCard Title="Contrats" Icon="@Icons.Material.Filled.Leaderboard" IconColor="Color.Secondary" Data="@contratData" Number="2" />
                                                </MudItem>
                                            </MudGrid>
                                        </MudCardContent>
                                    </MudPaper>
                                </MudItem>
                                <MudItem xs="12" md="12">
                                    <MudPaper Elevation="1">
                                        <MudCardContent>
                                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Color="Color.Primary" />
                                                <div>
                                                    <MudText Typo="Typo.h6">Nombre de RDV PRA</MudText>
                                                    <MudText Typo="Typo.caption">(pris - réalisés - à venir)</MudText>
                                                </div>
                                            </MudStack>
                                            <MudGrid>
                                                <MudItem xs="12" md="12">
                                                    <DonutCard Title="Rendez-vous" Icon="@Icons.Material.Filled.Leaderboard" IconColor="Color.Secondary" Data="@appointmentData" Labels="@appointmentLabels" Number="@((int)((appointmentData ?? new double[0]).Sum()))" />
                                                </MudItem>
                                            </MudGrid>
                                        </MudCardContent>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>
                        <MudTabPanel Text="Suivi">
                            <TrainingTable />
                        </MudTabPanel>
                    </MudTabs>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>
</div>

@code {
    [Parameter]
    public string userId { get; set; }
    [Parameter]
    public string weekId { get; set; }

    public User userInfo => stateContainerService.UserInfo;
    decimal turnover = 0;
    decimal bonus = 0;
    DateOnly today = DateOnly.FromDateTime(DateTime.Today);
    DateOnly firstYearDay = new DateOnly(DateTime.Today.Year, 1, 1);
    DateOnly lastYearDay = new DateOnly(DateTime.Today.Year, 1, 1).AddMonths(12).AddDays(-1);
    List<TempClass> allContracts = new();
    User commercial = new User();
    Models.Planning selectedPlanning = new Models.Planning();
    private string[] days = Array.Empty<string>();
    int daysSinceMonday;
    DateOnly monday;
    DateOnly friday;
    private int _activeTab = 0;
    List<Brief?> briefs = new();
    List<Debrief?> debriefs = new();
    string[] appointmentLabels = new[] { "Rendez-vous à venir", "Rendez-vous réalisés" };
    double[] appointmentData;

    double[] rentalData = new[] { 5.0 };
    double[] purchaseData = new[] { 2.0 };
    double[] contratData = new[] { 2.0 };

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        commercial = await userService.GetUserByIdAsync(Convert.ToInt32(userId));
        daysSinceMonday = ((int)today.DayOfWeek + 6) % 7;
        monday = today.AddDays(-daysSinceMonday);
        friday = monday.AddDays(4);
        days = GetWeekDays();
        if (commercial.Plannings.Count != 0)
        {
            selectedPlanning = commercial.Plannings.Where(p => p.Id == Convert.ToInt32(weekId)).FirstOrDefault();
        }
        else
        {
            selectedPlanning.CreatedAt = DateTime.Today;
        }
        briefs = await briefService.GetBriefByUserId(monday.ToDateTime(TimeOnly.MinValue), friday.ToDateTime(TimeOnly.MinValue), commercial.Id);
        debriefs = await debriefService.GetDebriefByUserAsync(monday.ToDateTime(TimeOnly.MinValue), friday.ToDateTime(TimeOnly.MinValue), commercial.Id);

        TempClass temp = new TempClass();
        turnover = await userService.GetUserTurnoverAsync(commercial.Name, firstYearDay, lastYearDay);
        bonus = await userService.GetUserBonusAsync(commercial.Name, firstYearDay, lastYearDay);
        var allContractsRaw = contractService.GetContractsByPeriod(commercial.Name, firstYearDay, lastYearDay);
        allContracts = new List<TempClass>();

        allContracts.Add(new TempClass
        {
            label = "Sauvegarde",
            contracts = allContractsRaw.Where(c => c.Sauvegarde == "OUI").ToList()
        });

        allContracts.Add(new TempClass
        {
            label = "Maintenance",
            contracts = allContractsRaw.Where(c => c.Maintenance == "OUI").ToList()
        });

        allContracts.Add(new TempClass
        {
            label = "Sécurité",
            contracts = allContractsRaw.Where(c => c.Sécurité == "OUI").ToList()
        });
        var nbAppointmentsRealised = await userService.GetNbAppointmentsAsync(commercial.Email, monday, today);
        var nbAppointmentsOnGoing = await userService.GetNbAppointmentsAsync(commercial.Email, today, friday);
        appointmentData = new double[] { nbAppointmentsOnGoing, nbAppointmentsRealised };
    }

    public class TempClass
    {
        public string label { get; set; }
        public List<EcolePerformanceSm?> contracts { get; set; } = new List<EcolePerformanceSm?>();
    }

    private string[] GetWeekDays()
    {
        var culture = System.Globalization.CultureInfo.GetCultureInfo("fr-FR");

        return Enumerable.Range(0, 5)
                         .Select(offset =>
                         {
                             var dayName = monday.AddDays(offset).ToString("dddd", culture);
                             return char.ToUpper(dayName[0]) + dayName.Substring(1);
                         })
                         .ToArray();
    }

    private RenderFragment GetIndicatorIcon(int goal, int realised) => @<MudIcon Icon="@GetIcon(goal, realised)" Color="@GetColor(goal, realised)" />;

    private Color GetColor(int goal, int realised)
    {
        if (goal == 0)
            return Color.Default;

        if (realised == goal / 2)
            return Color.Warning;

        if (realised < goal)
            return Color.Success; 

        return Color.Error;
    }

    private string GetIcon(int goal, int realised)
    {
        if (goal == 0)
            return Icons.Material.Filled.HorizontalRule;

        if (realised == goal / 2)
            return Icons.Material.Filled.SsidChart;

        if (realised < goal)
            return Icons.Material.Filled.ArrowOutward;

        return Icons.Material.Filled.Cancel;
    }
}
