@using EcoleDeLaPerformance.Ui.Helper
@using EcoleDeLaPerformance.Ui.Interfaces
@using EcoleDeLaPerformance.Ui.Models
@using EcoleDeLaPerformance.Ui.Shared.Components
@using System.ComponentModel.DataAnnotations
@inject ISnackbar snackbar
@inject IUserService userService
@inject IRoleService roleService
@inject IGradeService gradeService
@inject MailHelper mailHelper

@if (isInitialized)
{
    <MudDialog>
        <DialogContent>
            <MudForm @ref="form" Model="model">
                <MudGrid>
                    <MudItem md="4" lg="4" sm="12">
                        <MudTextField Label="Email"
                                      @bind-Value="model.Email" For="@(() => model.Email)" Validation="@(new EmailAddressAttribute() { ErrorMessage = "Veuillez saisir une adresse email valide" })" Required RequiredError="Email obligatoire !" />
                    </MudItem>
                    <MudItem md="4" lg="4" sm="12">
                        @* <MudTextField Label="Nom" Immediate="true" @bind-Value="model.Name" For="@(() => model.Name)" Required RequiredError="Prénom Nom obligatoire !" TextChanged="() => HandleSearchChange(model.Name)" /> *@
                        <MudAutocomplete T="string" Label="Nom" @bind-Value="model.Name" SearchFunc="@HandleSearchChange" TextChanged="OnNameSelected"
                                         ResetValueOnEmptyText="true" SelectValueOnTab="true" Clearable />
                    </MudItem>
                    <MudItem md="4" lg="4" sm="12">
                        <MudTextField Label="Entité/Site"
                                      @bind-Value="model.Entity" For="@(() => model.Entity)" Required RequiredError="Entité/Site obligatoire !" />
                    </MudItem>
                    <MudItem md="4" lg="4" sm="12">
                        <MudSelect T="string" Label="Role" Dense="true" @bind-Value="selectedRole" Clearable Required RequiredError="Role obligatoire !">
                            @foreach (var role in roleList)
                            {
                                <MudSelectItem Value="@role.Id.ToString()">@role.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    @if (roleList.Where(x => x.Id == Convert.ToInt32(selectedRole)).Select(x => x.Name).FirstOrDefault() == "Commercial")
                    {
                        <MudItem md="4" lg="4" sm="12">
                            <MudSelect T="string" Label="Statut" Dense="true" @bind-Value="selectedGrade" Clearable Required RequiredError="Grade obligatoire !">
                                @foreach (var grade in gradeList)
                                {
                                    <MudSelectItem Value="@grade.Id.ToString()">@grade.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem md="4" lg="4" sm="12">
                            <MudSelect T="string" Label="Directeur" Dense="true" TextChanged="() => SelectDirector(selectedDirector)" @bind-Value="selectedDirector" Clearable Required RequiredError="Directeur obligatoire !">
                                @{
                                    if (directorList != null && directorList.Count != 0)
                                    {
                                        foreach (var director in directorList)
                                        {
                                            <MudSelectItem Value="@director.Id.ToString()">@(director.Name.ToUpper())</MudSelectItem>
                                        }
                                    }
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem md="4" lg="4" sm="12">
                            <MudDatePicker Label="Date début suivi" @bind-Date="startDate" Required RequiredError="Date obligatoire !" />
                        </MudItem>
                    }
                </MudGrid>
            </MudForm>
        </DialogContent>
        <DialogActions>
            <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="Confirm">Valider</MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    [CascadingParameter] IMudDialogInstance mudDialog { get; set; }

    [Parameter]
    public User userInfo { get; set; }

    User model = new User();
    private MudForm form;
    public string? selectedRole { get; set; }
    public string? selectedGrade { get; set; }
    public string? selectedDirector;
    DateTime? startDate = null;
    public List<Role> roleList;
    public List<Grade> gradeList;
    public List<User> directorList = new List<User>();
    public List<User> usersList = new List<User>();
    public List<User> usersName = new List<User>();
    private bool isInitialized { get; set; }

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        usersList = await userService.GetUsersAsync();
        roleList = await roleService.GetRolesAsync();
        gradeList = await gradeService.GetGradesAsync();
        directorList = usersList.Where(x => x.DeletedAt == null && x.Role.Name == "Directeur").ToList();
        isInitialized = true;
    }

    private async System.Threading.Tasks.Task SelectDirector(string value)
    {
        selectedDirector = value;
        StateHasChanged();
    }

    private async System.Threading.Tasks.Task<IEnumerable<string>> HandleSearchChange(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Enumerable.Empty<string>();

        usersName = userService.GetUserAAD(value);

        return usersName.Select(x => x.Name).Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private void OnNameSelected(string selectedName)
    {
        var user = usersName.FirstOrDefault(u => u.Name == selectedName);
        if (user != null)
        {
            model.Email = user.Email;
            model.Entity = user.Entity;
        }
        else
        {
            model.Email = null;
            model.Entity = null;
        }
    }

    public async void Confirm()
    {
        try
        {
            await form.Validate();
            if (form.IsValid)
            {
                User newUser = new User()
                {
                    Email = model.Email,
                    Name = model.Name,
                    Entity = model.Entity,
                    RoleId = Convert.ToInt32(selectedRole),
                    IsFirstConnection = true,
                };
                if (roleList.Where(x => x.Id == Convert.ToInt32(selectedRole)).Select(x => x.Name).FirstOrDefault() == "Commercial")
                {
                    newUser.DirectorId = Convert.ToInt32(selectedDirector);
                    newUser.GradeId = Convert.ToInt32(selectedGrade);
                    newUser.StartFollowUp = DateOnly.FromDateTime(startDate.Value);
                }
                await userService.InsertUserAsync(newUser);
                mailHelper.SendMailNewAccount(newUser.Email, (newUser.Name), (userInfo.Name), userInfo.Email);
                snackbar.Add("L'utilisateur a bien été créé !", Severity.Success);
                mudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                snackbar.Add("Veuillez remplir les champs obligatoires !", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            snackbar.Add($"Erreur lors de l'enregistrement de l'utilisateur : {ex.Message}", Severity.Error);
            SentrySdk.CaptureException(ex);
        }
        StateHasChanged();
    }
}
